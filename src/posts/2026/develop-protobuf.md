---
title: Изобретая протобаф
author: kafkiansky
date: 2026-01-08
tags:
  - php
  - protobuf
draft: false
---

Поскольку в классическом `php` некоторые вещи иногда нельзя реализовать полностью, появляется настойчивая необходимость осуществить это не вполне привычными средствами. К этим наполовину сделанным или, напротив, наполовину не сделанным реализациям можно отнести и `grpc`, который со стороны `protoc` — по понятным, как мне кажется, для всех причинам — реализован только в качестве клиентского фреймворка. Чтобы пойти дальше, то есть иметь возможность принимать `grpc` трафик в качестве сервера, `php` необходимо отказаться от своей природы — и перестать умирать. Насколько я вижу, такую возможность сейчас могут предложить только `roadrunner`, где `grpc` сервером (или, правильнее будет сказать, «`grpc` гейтвеем») будет выступать воркер на `go`, что, правда, не совсем честно, или `swoole`, где реализация выглядит более нативной, хотя и вызывающей вопросы, касающиеся своей актуальности. На самом деле можно пойти другой дорогой — и изобрести весь стек заново.

Это нужно не потому, что мы хотим решить задачу другим способом, а потому, что популярность `grpc` как протокола общения и `protobuf` как формата сериализации способны конкурировать с классическим `http` и `json` там, где браузер не нужен. Так, некоторые современные системы вроде `etcd` и `ydb` выбирают `grpc` в качестве основного клиентского протокола, не изобретая собственный, как делали их предшественники в лице `redis` и `postgresql`. В то же время `protobuf` обладает другими достоинствами вроде хорошего сжатия, строгой типизации и упрощенной эволюции в сторону обратной и прямой совместимости. Вместе с `protoc` получается фреймворк, который, пожалуй, является современной заменой «`json over http`» подходу. Однако это все не для `php`. Сложно назвать то, как вписан `php` в `protoc` прямо сейчас, полным и тем более современным стеком. Поэтому надо взять меч в свои руки и вырубить себе дорогу самостоятельно.

У этого дракона (если на короткое время продолжить поддерживать мифологическое настроение), как это обычно бывает, есть три головы, которые в данном необычном случае нам надо не срубить, а вырастить: это `protobuf` сериализация, `grpc` протокол и плагин для `protoc`.

Начиная с сериализации, можно было бы упрекнуть себя в том, что делать такое на языке, обладающем малыми возможностями по управлению памятью,  — дело, ни к чему хорошему не приводящее, однако мы делаем ставку на неблокирующий `php`, то есть собираемся оптимизировать `io`, а не `cpu`, которое все равно сравнительно быстрее. Итак, `protobuf` — это `key-value` формат. Это важно понимать, потому что бинарные форматы обычно являются последовательными, поэтому не требуют передачу ключей, занимающих лишнее место. Так устроен `amqp` протокол, протоколы `kafka`, `cassandra`, `postgresql`, нативный протокол `clickhouse`, `mysql` и многих других.